events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Security: Hide nginx version
    server_tokens off;

    # Security: Request size limits (5MB for file uploads)
    client_max_body_size 5m;
    client_body_buffer_size 128k;

    server {
        listen 80;

        # Security Headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.google.com https://www.gstatic.com; frame-src https://www.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        # 1. Landing Page - Meme Dashboard (guest-friendly)
        location = / {
            proxy_pass http://meme_service:5000/static/index.html;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 2. Login/Register Page
        location = /login {
            proxy_pass http://auth_service:5000/static/index.html;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 2b. Auth Service Static Assets (CSS/JS for /login page)
        # These are requested as /css/... and /js/... from the /login page
        location ~ ^/(css|js)/ {
            proxy_pass http://auth_service:5000/static$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 2. Password Reset Page (serve frontend for GET, API for POST)
        location = /auth/reset-password {
            # For GET requests, serve the frontend
            if ($request_method = GET) {
                rewrite ^ /static/index.html break;
            }
            # For POST requests (and others), proxy to API
            proxy_pass http://auth_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 3. Auth Frontend Static Assets (for reset-password page)
        location ~ ^/auth/(css|js)/ {
            rewrite ^/auth/(.*)$ /static/$1 break;
            proxy_pass http://auth_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 4. Auth Service API
        location /auth {
            proxy_pass http://auth_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 4. Meme Service Dashboard
        location = /dashboard {
            proxy_pass http://meme_service:5000/static/index.html;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # 5. Dashboard Static Assets
        location /dashboard/ {
            rewrite ^/dashboard/(.*)$ /static/$1 break;
            proxy_pass http://meme_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 6. Meme Service API
        location /memes {
            proxy_pass http://meme_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Increase timeout for file uploads
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # 6b. Admin Endpoints (Meme Service)
        location /admin {
            proxy_pass http://meme_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 7. Verification Service
        location /verify {
            proxy_pass http://verification_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 8. MFA Service
        location /mfa {
            proxy_pass http://mfa_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 9. Account Service API
        location /account {
            proxy_pass http://account_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 10. Account Settings Page
        location = /settings {
            proxy_pass http://account_service:5000/static/index.html;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 11. Settings Static Assets
        location /settings/ {
            rewrite ^/settings/(.*)$ /static/$1 break;
            proxy_pass http://account_service:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 12. Health Check
        location /health {
            return 200 'Gateway is healthy';
            add_header Content-Type text/plain;
        }
    }
}

